## tlgdb

Проект предназначен для тарификации телеграмм и включает в себя три приложения:

- __tlg__ - база данных телеграмм 
- __tariftlg__ - телеграфные тарифы
- __reestr__ - подготовка суточных реестров отправленных телеграмм для внесения в биллинговую систему

В проекте используется БД mysql, настройки подключения к базе вынесены в файл ***my.cnf***.  
Для работы с проектом используется стартовая страница ***index.html***, ссылки в которой настроены на работу с 
django-сервером, запущенном на порту 8000 на локальном компьютере. 

---

### tlg

В приложении __tlg__ используется одна модель: __Tlg__. Работа с ней организована через раздел _"БД телеграмм"_ 
стартовой страницы.

Управление БД телеграмм производится через адмистриративную подсистему django. 

Для демонстрации возможностей программы подготовлена тестовая БД телеграмм (файл ***tlg0.csv***). Что бы ее загрузить, 
нужно в административной подсистеме в модели _Телеграммы_ нажать кнопку _ИМПОРТ ТЕСТВОЙ БД_. 

Тестовая БД сожержит записи о 50 телеграммах за 1-2 августа 2022 г.

Просмотреть содержимое БД можно через форму _"Просмотр БД телеграмм"_ на стартовой странице. Доступны фильтры по 
дате, по входящему и исходящему направлениям.

Средствами Django Rest Framework реализовано API работы с БД телеграмм. Описание см. в файле ***api.md***.


---

### tariftlg

В приложении __tariftlg__ используются три модели:  
- __TlgTarif__ - тарифы для отправки телеграмм по России  
- __Country__ - список стран экс-СССР и перечень допустимых в этих странах типов телеграмм   
- __TlgTarifCountry__ - тарифы для отправки телеграмм в страны экс-СССР

Управление тарифами производится через адмистриративную подсистему django.   
Тестовые тарифы можно загрузить, нажав в административной подсистеме в любой модели раздела _TLGTARIF_ кнопку 
_ИМПОРТ ТЕСТОВЫХ ТАРИФОВ_.  
В административной подсистеме реализована дополнительная валидация вводимых интервалов действия тарифов 
(на непересечение с уже существующими).

На стартовой странице в разделе _"Телеграфные тарифы"_ можно вызвать калькулятор стоимости телеграмм.

Описание API см. в файле ***api.md***.


---

### reestr

В приложении __reestr__ используются модели:  
- __UserTlg__ - опреаторы связи/биллинга, расширение стандартной модели django __User__ с указанеим прав на операции формирования реестра и биллинга, а так же с маской канала оператора для выборки его телеграмм из БД   
- __Client__ - список клиентов, отправляющих платные телеграммы, по которым нужно формировать реестры   
- __Record__ - протарифицрованные телеграммы (ForeignKey на экземпляр модели __Tlg__, __Country__, __Client__ и на __Reestr__)
- __Reestr__ - суточные реестры телеграмм разных операторов (ForeignKey на создателя реестра __UserTlg__)

Управление опреаторами и клиентами производится через адмистративную подсистему django.   
Тестовые учетные данные операторов можно создать, нажав в административной подсистеме в модели _Опреаторы связи/биллинга_ кнопку _СОЗДАНИЕ ТЕСТОВЫХ ПОЛЬЗОВАТЕЛЕЙ_.  
Тестовых клиентов можно создать, нажав в административной подсистеме в модели _Клиенты_ кнопку _СОЗДАНИЕ ТЕСТОВЫХ КЛИЕНТОВ_.  

В тестовых учетных данных два опреатора связи (***pok-2*** и ***tgn***) и один оператор биллинговой системы (bill-1). У всех пароль ***tagan12***.

На стартовой странице в разделе _"Реестр платных телеграмм"_ можно авторизоваться, сформировать реестр за определенную дату (для оператора связи),
внести данные реестра в биллинговую систему (для оператора биллинговой системы),
просмотреть и отправить по почте детализацию счета клиентам (для оператора биллинговой системы).


---

### Порядок действий

#### Создание реестра

После окончания рабочего дня оператору связи нужно составить реестр платных телеграмм. 
Он выбирает дату в пункте _Сформировать реестр_ и нажимает кнопку _Создать_. Если он еще не авторизован, система предложит ему сделать это.
В итоге выводится страница со списком телеграмм, отправленных этим отделением связи за указанные сутки.
Оператор в левом столбце выбирает чекбоксы у платных телеграмм и нажимает кнопку _Добавить_.    

Открывается страница, в которой к каждой телеграмме привязывается клиент, для которого она была отправлена (выпадающий список в правом столбце).
Ошибочно добавленные телеграммы можно удалить из списка, нажав на крест в левом столбце.
При необходимости можно нажать кнопку _Назад_ и вернуться на предыдущую страницу, чтобы добавить в список новые телеграммы.
При этом телеграммы, которые уже есть в списке, будут выделены голубым цветом.
После того, как оператор выберет для каждой телеграммы клиента, он нажимает кнопку _Тарифицировать_.

На странице тарификации все телеграммы загружаются по умолчанию в режиме автоматической тарификации 
(определяется тип телеграммы, ее категория и виды, количество слов). В этом режиме можно изменить страну получателя,
категорию и виды телеграммы, при этом автоматически изменится стоимость телеграммы и ее составляющих.
В случае, если будет выбрана недопустимая комбинация, телеграмма подсветится красным цветом и во всплывающей подсказке будет указано несоответствие.
На всякий случай предусмотрен режим ручной тарификации (выбирается установкой чекбокса с столбце _р/т_).
В этом режиме можно изменить количество слов и нажать кнопку _Рассчитать_. В результате стоимость телеграммы рассчитается в соответствии с текущими тарифами.
Также можно изменить любую составляющую стоимости телеграммы (включая итоговую и с НДС). 
Затем необходимо нажать кнопку _Сохранить_, чтобы изменения записались в БД. После окончания тарификации нажимается кнопка _Подтвердить_.

Далее загружается страница с итоговым видом реестра. Нужно ввести фамилию оператора и нажать кнопку _Создать_.
После этого реестр станет доступен для внесения в биллинговую систему. Пока он не внесен в биллинг, его можно отредактировать, нажав кнопку _Изменить_.

---

#### Биллинг

Если выбрать месяц и нажать кнопку _Открыть_ в пункте _Биллинговая система_, будет выведен список реестров за нужный месяц.
Реестры, формирование которых не завершено, имееют статус "Черновик", завершено - "Сформирован". Реестры внесеные с биллинговую систему имеют статус "Закрыт". 
У оператора связи отобразятся только реестры его отделения, у оператора биллинговой системы - все.

Оператор связи может по ссылке открыть страницу с редактированием черновика и сформированного реестра и просмотреть реестры со статусом "Закрыт".

Оператор биллинга, перейдя по ссылке на реестр со статусом "Сформирован" может внести его в биллинговую систему, нажав кнопку _Биллинг_.
Статус реестра после этого измениться на "Закрыт". Перейдя по ссылке на реестр со статусом "Закрыт" можно отменить биллинг, нажав соответствующую кнопку.
Реестры-черновики оператор биллинга открыть не может.

---

#### Детализация

Если выбрать месяц и нажать кнопку _Открыть_ в пункте _Детализация_, будет выведена таблица с клиентами. 
Ссылка с названием клиента открывает страницу с детализацией, клик по email-адресу отправляет детализацию на почту клиенту.
Операторы связи доступа к детализации не имеют.